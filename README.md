# Ï¥àÍ∏â

# ElasticSearchÎûÄ?

> ÎèÑÏÑúÍ¥Ä ÏÇ¨ÏÑú ÏÑ†ÏÉùÎãòÏù¥Îã§
> 
- Ï±ÖÏù¥ ÏàòÏ≤ú Í∂åÏù¥ ÏûàÏñ¥ÎèÑ Ï†úÎ™©Ïù¥ÎÇò ÏûëÍ∞Ä Ïù¥Î¶ÑÏúºÎ°ú `ÏàúÏãùÍ∞ÑÏóê Ï∞æÏïÑÏ£ºÎäî` ÏïÑÏ£º ÎòëÎòëÌïú ÏÇ¨ÏÑúÏù¥Îã§
- Ïù¥ ÏÇ¨ÏÑúÎäî  Ï±ÖÏùÑ Ïñ¥ÎñªÍ≤å Ï∞æÏïÑÏïº ÏïåÍ≥† ÏûàÏñ¥ÏÑú, Ïö∞Î¶¨Í∞Ä Î¨ºÏñ¥Î≥¥Î©¥ `‚ÄúÎπ®Í∞Ñ Î™®Ïûê‚Äù` Ïù¥ÏïºÍ∏∞ Ï§ë Ï†úÎ™©Ïóê Îπ®Í∞ÑÏù¥ Îì§Ïñ¥Í∞Ñ Í±∏ Í∏àÎ∞© Ï∞æÏïÑÏ§ÄÎã§.
- Ïù¥Í≤ÉÏù¥ ElasticSearchÏùò `Í≤ÄÏÉâ Í∏∞Îä•`Ïù¥Îã§

---

# Í∞úÎÖê

`document` : ÌïòÎÇòÏùò Îç∞Ïù¥ÌÑ∞ ‚áí Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∞ùÏ≤¥ (Ïòà : Í≤åÏãúÍ∏Ä ÌïòÎÇò)

`Index` : Ï±ÖÏû•  ‚áí Î¨∏ÏÑúÎì§ÏùÑ Ï†ÄÏû•ÌïòÎäî Í≥µÍ∞Ñ

`Field` : Î¨∏ÏÑúÏùò ÏÜçÏÑ± ‚áí Ï†úÎ™©, ÎÇ¥Ïö©, ÏûëÏÑ±Ïûê Îì±

`Mapping` : Î¨∏ÏÑúÏùò Íµ¨Ï°∞ Ï†ïÏùòÏÑú ‚áí ÏÑ§Í≥ÑÎèÑ

`Query` :  ÏÇ¨ÏÑúÏóêÍ≤å ÌïòÎäî ÏßàÎ¨∏ ‚áí Í≤ÄÏÉâ Ï°∞Í±¥

`Match` : Analyzer(Î∂ÑÏÑùÍ∏∞)Î•º ÌÜµÌï¥ ÎÇòÎàà Îã®Ïñ¥ Í∏∞Ï§ÄÏúºÎ°ú Í≤ÄÏÉâ ‚áí ÏûêÏó∞Ïñ¥ Í≤ÄÏÉâ

`Term` : Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäî Í∞íÏùÑ Ï∞æÏùå (Î∂ÑÏÑù x) ‚áí Ï†ïÌôïÌïú ÌÇ§ÏõåÎìú Îß§Ïπ≠

`Bool` : Ïó¨Îü¨ ÏøºÎ¶¨Î•º Ï°∞Ìï©Ìï¥ÏÑú Ï°∞Í±¥ Í≤ÄÏÉâ 

`must` : AND

`should` : OR (ÏÑ†ÌÉùÏ†ÅÏúºÎ°ú ÎßåÏ°±ÌïòÎ©¥ Ï†êÏàò ‚Üë)

`must_not` : Ï†úÏô∏ Ï°∞Í±¥

`filter` : Ï†êÏàò ÏòÅÌñ• ÏóÜÏù¥ Ï°∞Í±¥ ÌïÑÌÑ∞ÎßÅ

---

# API Ï†ïÎ¶¨

| Î©îÏÑúÎìú | URL | ÏÑ§Î™Ö |
| --- | --- | --- |
| PUT / POST | `/{index}` | Ïù∏Îç±Ïä§ ÏÉùÏÑ± |
| DELETE | `/{index}` | Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú |
| POST | `/{index}/_doc` | Î¨∏ÏÑú Ï∂îÍ∞Ä(ID ÏûêÎèô ÏÉùÏÑ±) |
| PUT | `/{index}/_doc/{id}` | Î¨∏ÏÑú Ï∂îÍ∞Ä ÎòêÎäî ÏàòÏ†ï (ID ÏßÄÏ†ï) |
| GET | `/{index}/_doc/{id}` | ÌäπÏ†ï Î¨∏ÏÑú Ï°∞Ìöå |
| DELETE | `/{index}/_doc/{id}` | ÌäπÏ†ï Î¨∏ÏÑú ÏÇ≠Ï†ú |
| GET / POST | `/{index}/_search` | Î¨∏ÏÑú Í≤ÄÏÉâ |
| GET | `/_cat/indices?v` | Î™®Îì† Ïù∏Îç±Ïä§ Î≥¥Í∏∞ (Ïù∏Îç±Ïä§ Ïπ¥ÌÉàÎ°úÍ∑∏) |
| GET | `/_cat/health?v` | ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÉÅÌÉú ÌôïÏù∏ |
| GET | `/{index}/_mapping` | Ïù∏Îç∞Ïä§ ÌïÑÎìú Íµ¨Ï°∞ ÌôïÏù∏ |

---

# Ïã§Ïäµ

> Ïö∞Î¶¨ Í≤åÏãúÍ∏Ä PostÎ•º ElasticSearchÏóê ÎÑ£ÎäîÎã§Í≥† Í∞ÄÏ†ï
> 

## 0. ÎèÑÏª§ Íµ¨ÏÑ±

- ÌòÑÏû¨ KafkaÎèÑ Í∞ôÏù¥ ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÍ∏∞ ÎïåÎ¨∏Ïóê Í∞ôÏù¥ ÏûàÎã§
- Elasticsearch Îßå ÏÇ¨Ïö©Ìï† Í±∞Î©¥ KibanaÏôÄ Elasticsearch ÏÑ§Ï†ïÎßå ÌïòÎ©¥ ÎêúÎã§.

```java
version: '3'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka1:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka1
    container_name: kafka1
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka1:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    depends_on:
      - zookeeper

  kafka2:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka2
    container_name: kafka2
    ports:
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka2:29093,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:29093,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    depends_on:
      - zookeeper

  kafka3:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka3
    container_name: kafka3
    ports:
      - "9094:9094"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka3:29094,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3:29094,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    depends_on:
      - zookeeper

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    networks:
      - elk

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.9
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - elk

networks:
  elk:
    driver: bridge

```

## 1. ÏùòÏ°¥ÏÑ± Ï∂îÍ∞Ä (build.gradle)

```groovy
implementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch'
```

- gradle ÏóÖÎç∞Ïù¥Ìä∏ Ìï¥Ï£ºÍ∏∞

## 2. Post EntityÎ•º Elasticsearch Î¨∏ÏÑúÎ°ú Îì±Î°ùÌïòÍ∏∞

```java
package com.example.learnspringboot.entity;

import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;

@Getter @Setter
@NoArgsConstructor @AllArgsConstructor
@Builder
@Document(indexName = "posts") // postsÎùºÎäî Ïù∏Îç±Ïä§Ïóê Ï†ÄÏû•Îê®
public class Post {

    @Id
    private Long id;
    private String title;
    private String content;
}
 
```

## 3. Elasticsearch Ïö© Repository ÎßåÎì§Í∏∞

```java
package com.example.learnspringboot.repository;

import com.example.learnspringboot.entity.Post;
import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;

public interface PostElasticRepository extends ElasticsearchRepository<Post, Long> {
    // title Í≤ÄÏÉâ ÏòàÏãúÎèÑ Í∞ÄÎä•Ìï¥Ïßê
}

```

## 4. Elasticsearch Service ÎßåÎì§Í∏∞

```java
package com.example.learnspringboot.service;

import com.example.learnspringboot.entity.Post;
import com.example.learnspringboot.repository.PostElasticRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class ElasticsearchService {

    private final PostElasticRepository postElasticRepository;

    public void saveToElasticsearch(Post post) {
        postElasticRepository.save(post);
        System.out.println("üîç ElasticsearchÏóê Ï†ÄÏû• ÏôÑÎ£å: " + post.getTitle());
    }
}

```

## 5. PostServiceÏóêÏÑú Ï†ÄÏû•Ïãú ElasticsearchÏóêÎèÑ Ï†ÄÏû•

```java
public Post createPost(Post post) {
    Post savedPost = postRepository.save(post);
    kafkaProducerService.send(savedPost); // Kafka
    elasticsearchService.saveToElasticsearch(savedPost); // Elasticsearch Ï∂îÍ∞Ä
    return savedPost;
}
```

# ÌÖåÏä§Ìä∏ÌïòÍ∏∞

## Kibana

1. Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú [localhost:5601](http://localhost:5601) (Kibana Ï†ëÏÜçÎê®)

![image.png](%E1%84%8E%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B8%201d181d8a13f080b49ccbf15f2b071d0c/image.png)

## ÏÇ¨Ïö© ÏòàÏãú1

1. Ïù∏Îç±Ïä§ ÏÉùÏÑ±

```java
PUT /posts
```

1. Î¨∏ÏÑú Ï†ÄÏû• (ID ÏûêÎèô ÏßÄÏ†ï)

```java
POST /posts/_doc
Content-Type: application/json

{
  "title": "Elastic Î∞∞Ïö∞Í∏∞",
  "content": "ÏâΩÍ≥† Ïû¨ÎØ∏ÏûàÎã§!"
}
```

1. Î¨∏ÏÑú Ï†ÄÏû• (ID ÏßÅÏ†ë ÏßÄÏ†ï urlÏù¥ Îã§Î¶Ñ)

```java
PUT /posts/_doc/1
Content-Type: application/json

{
  "title": "Ï≤´ Î≤àÏß∏ Í∏Ä",
  "content": "Ïö∞Î¶¨Îäî ElasticsearchÎ•º Î∞∞ÏõåÏöî"
}

```

1. Î¨∏ÏÑú Ï°∞Ìöå

```java
GET /posts/_doc/1
```

1. Î¨∏ÏÑú ÏÇ≠Ï†ú

```java
DELETE /posts/_docs/1
```

1. Ï†ÑÏ≤¥ Î¨∏ÏÑú Ï°∞Ìöå

```java
GET /posts/_search

{
  "query": {
    "match_all": {}
  }
}
```

1. Í≤ÄÏÉâ ÏøºÎ¶¨

```java
GET /posts/_search

{
  "query": {
    "match": {
      "title": "Elastic"
    }
  }
}

```

## ÏÇ¨Ïö© ÏòàÏãú2

> match, term, boolÏùÑ Ïù¥Ïö©Ìï¥ Í≤ÄÏÉâÌïòÍ∏∞
> 
- ÏòàÏãú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    
    ```java
    POST http://localhost:9200/posts/_doc
    {
      "title": "ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî ÎÜÄÎùºÏö¥ Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§.",
      "content": "ElasticsearchÎäî Î°úÍ∑∏ Î∂ÑÏÑù, Í≤ÄÏÉâ, ÌÜµÍ≥ÑÏóê Í∞ïÎ†•Ìï©ÎãàÎã§."
    }
    ```
    

### Match - Îã®Ïñ¥Î•º Î∂ÑÏÑùÌï¥ÏÑú Í≤ÄÏÉâ

```java
GET http://localhost:9200/posts/_search
{
  "query": {
    "match": {
      "title": "Í≤ÄÏÉâÏóîÏßÑ"
    }
  }
}
```

- ‚ÄúÍ≤ÄÏÉâÏóîÏßÑ‚ÄùÏùÄ ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú ‚ÄúÍ≤ÄÏÉâ‚Äù+‚ÄùÏóîÏßÑ‚Äù+‚ÄùÏûÖÎãàÎã§‚ÄùÏúºÎ°ú Î∂ÑÏÑùÎêòÏñ¥ Ï∞æÏïÑÏßÑÎã§
    - ÎùºÍ≥† ÏòàÏÉÅÏùÑ ÌñàÎäîÎç∞ Í≤ÄÏÉâÏù¥ Ïïà ÎêúÎã§
    - NoriÎ∂ÑÏÑùÍ∏∞ ÎòêÎäî IK Î∂ÑÏÑùÍ∏∞ Í∞ôÏùÄ ÌïúÍ∏Ä Ï†ÑÏö© Î∂ÑÏÑùÍ∏∞Î•º ÏÇ¨Ïö©Ìï¥Ïïº ÌïúÎã§.
    ÏïÑÎûòÏóê Í≥ÑÏÜç..

### Term - Îã®Ïñ¥ Ï†ÑÏ≤¥Í∞Ä Ï†ïÌôïÌûà ÏùºÏπòÌï† ÎïåÎßå Í≤ÄÏÉâ

```java
GET http://localhost:9200/posts/_search
{
  "query": {
    "term": {
      "title.keyword": "ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî ÎÜÄÎùºÏö¥ Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§."
    }
  }
}
```

- Í≤∞Í≥º
    - `title.keyword` ÌïÑÎìúÎäî Î∂ÑÏÑù ÏóÜÏù¥ Ï†ÑÏ≤¥ Î¨∏ÏûêÏó¥ Í∏∞Ï§Ä Í≤ÄÏÉâ
    - ‚ÄúÏ†ïÌôïÌûà Ïù¥ Îã®Ïñ¥ÏôÄ ÏùºÏπòÌïòÎäî Í≤ÉÎßå Ï∞æÏïÑÏ§ò‚Äù : "Í≤ÄÏÉâÌï† Îã®Ïñ¥ÎÇò Î¨∏Ïû•‚Äù

### Bool - Ïó¨Îü¨ Ï°∞Í±¥ÏùÑ ÎèôÏãúÏóê Ï§Ñ Îïå

```java
GET http://localhost:9200/posts/_search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "title": "Í≤ÄÏÉâ" } },
        { "match": { "content": "Elasticsearch" } }
      ],
      "must_not": [
        { "match": { "title": "ÎäêÎ¶º" } }
      ]
    }
  }
}
```

---

# ÌòïÌÉúÏÜå Î∂ÑÏÑù

> Nori Î∂ÑÏÑùÍ∏∞ Í∏∞Î∞ò elasticsearch Ïù∏Îç±Ïä§ ÏÑ§Í≥ÑÎ•º ÎßåÎì§Ïñ¥Î≥¥Ïûê
> 
- Nori Analyzer ÏÑ§ÏπòÎ•º Ìï¥Ï£ºÏûê

```java
// Nori Analyzer ÏÑ§Ïπò
docker exec -it [elasticsearch-container-name] bin/elasticsearch-plugin install analysis-nori
// Ïª®ÌÖåÏù¥ÎÑà Ïû¨Ïã§Ìñâ
docker restart [elasticsearch-container-name]

```

## 1. Í∏∞Ï°¥ Ïù∏Îç±Ïä§Í∞Ä ÏûàÎã§Î©¥ ÏÇ≠Ï†ú

```java
DELETE /posts
```

## 2. Nori Î∂ÑÏÑùÍ∏∞ Í∏∞Î∞ò Ïù∏Îç±Ïä§ ÎßåÎì§Í∏∞

- `title`Í≥º `content` ÌïúÍµ≠Ïñ¥ Í≤ÄÏÉâ ÏµúÏ†ÅÌôî

```java
PUT /posts_kor
{
  "settings": {
    "analysis": {
      "analyzer": {
        "my_korean_analyzer": {
          "type": "custom",
          "tokenizer": "nori_tokenizer"
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "my_korean_analyzer"
      },
      "content": {
        "type": "text",
        "analyzer": "my_korean_analyzer"
      }
    }
  }
}
```

## 3. Î¨∏ÏÑú Ï†ÄÏû•(POST)

```java
POST /posts_kor/_doc
{
  "title": "Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§",
  "content": "Ïö∞Î¶¨Îäî ÌïúÍµ≠Ïñ¥ ÌòïÌÉúÏÜå Î∂ÑÏÑùÍ∏∞Î°ú Í≤ÄÏÉâ ÌíàÏßàÏùÑ ÎÜíÏûÖÎãàÎã§"
}
```

## 4. Í≤ÄÏÉâ(GET with match)

```java
GET /posts_kor/_search
{
  "query": {
    "match": {
      "title": "Í≤ÄÏÉâÏóîÏßÑ"
    }
  }
}
```

## 5. Î∂ÑÏÑùÍ∏∞ ÏßÅÏ†ë ÌÖåÏä§Ìä∏

```java
GET /posts_kor/_analyze
{
  "analyzer": "my_korean_analyzer",
  "text": "Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§"
}
```

- Í≤∞Í≥º

```java
{
    "tokens": [
        {
            "token": "Í≤ÄÏÉâ",
            "start_offset": 0,
            "end_offset": 2,
            "type": "word",
            "position": 0
        },
        {
            "token": "ÏóîÏßÑ",
            "start_offset": 2,
            "end_offset": 4,
            "type": "word",
            "position": 1
        },
        {
            "token": "Ïù¥",
            "start_offset": 4,
            "end_offset": 7,
            "type": "word",
            "position": 2
        },
        {
            "token": "·ÑáÎãàÎã§",
            "start_offset": 4,
            "end_offset": 7,
            "type": "word",
            "position": 3
        }
    ]
}
```

- Nori Î∂ÑÏÑùÍ∏∞Í∞Ä `‚ÄúÍ≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§‚Äù`Î•º ÏúÑÏôÄ Í∞ôÏù¥ Î∂ÑÎ¶¨Î•º ÌñàÍ∏∞ ÎïåÎ¨∏Ïóê `‚ÄúÍ≤ÄÏÉâÏóîÏßÑ‚Äù` Í≤ÄÏÉâÏóê ÏÑ±Í≥µÌñàÎã§

# ÏöîÏïΩ

- Í≤åÏãúÍ∏ÄÏùÑ Ï±ÖÏ≤òÎüº ElasticsearchÎùºÎäî ÎèÑÏÑúÍ¥ÄÏóê Ï†ÄÏû•ÌïúÎã§.
- KibanaÎùºÎäî ÏÑúÏÇ¨ÌïúÌÖå Î¨ºÏñ¥Î≥¥Î©¥ Í∏àÎ∞© Ï∞æÏïÑÏ§ÄÎã§.
- Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ï†ÄÏû•ÌïòÍ≥†, Îπ†Î•¥Í≤å Í≤ÄÏÉâÌïòÎäîÎç∞ ÏµúÍ≥†Îã§


# Ï§ëÍ∏â

# Í≥†Í∏â Í≤ÄÏÉâÏóîÏßÑ Í∏∞Îä• Íµ¨Ï∂ï

1. ÏûêÎèôÏôÑÏÑ± (Auto-complete) - `Edge NGram`
    - ÏÇ¨Ïö©ÏûêÍ∞Ä `‚ÄúÍ≤Ä‚Äù`Îßå Ï≥êÎèÑ `‚ÄúÍ≤ÄÏÉâÏóîÏßÑ‚Äù`Ïù¥ Ï∂îÏ≤úÎêòÎäî Í∏∞Îä•
2. ÎèôÏùòÏñ¥ ÌôïÏû• (Synonym) - `‚ÄúÏûêÎèôÏ∞®‚Äù` ‚Üí `‚ÄúÏ∞®‚Äù`, `‚ÄúÏäπÏö©Ï∞®‚Äù` Îì± ÌôïÏû•
3. Kibana ÏãúÍ∞ÅÌôî Ïó∞Îèô
    - Í≤ÄÏÉâÏñ¥ Ìä∏Î†åÎìú, Ïù∏Í∏∞ ÌÇ§ÏõåÎìú Îì±ÏùÑ ÎåÄÏãúÎ≥¥ÎìúÎ°ú ÌëúÌòÑ

## 1. ÏûêÎèô ÏôÑÏÑ± Ïù∏Îç±Ïä§ ÎßåÎì§Í∏∞

```java
PUT /autocomplete_post
{
  "settings": {
    "analysis": {
      "analyzer": {
        "autocomplete_analyzer": {
          "tokenizer": "autocomplete_tokenizer"
        },
        "autocomplete_search_analyzer": {
          "tokenizer": "standard"
        }
      },
      "tokenizer": {
        "autocomplete_tokenizer": {
          "type": "edge_ngram",
          "min_gram": 1,
          "max_gram": 20,
          "token_chars": ["letter", "digit"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "autocomplete_analyzer",
        "search_analyzer": "autocomplete_search_analyzer"
      }
    }
  }
}
```

## 2. Î¨∏ÏÑú ÎÑ£Í∏∞

```java
POST /autocomplete_post/_doc
{
  "title": "Í≤ÄÏÉâÏóîÏßÑ"
}
```

## 3. ÏûêÎèôÏôÑÏÑ± Í≤ÄÏÉâ

- `‚ÄúÍ≤Ä‚Äù`Ïù¥ÎùºÍ≥† Í≤ÄÏÉâÌñàÎã§Í≥† Í∞ÄÏ†ï

```java
GET /autocomplete_post/_search
{
  "query": {
    "match": {
      "title": "Í≤Ä"
    }
  }
}
```

- Í≤∞Í≥º

```java
{
    "took": 643,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 0.2876821,
        "hits": [
            {
                "_index": "autocomplete_post",
                "_type": "_doc",
                "_id": "NjxkIpYBuHtZHrl3KkEy",
                "_score": 0.2876821,
                "_source": {
                    "title": "Í≤ÄÏÉâÏóîÏßÑ"
                }
            }
        ]
    }
}
```

- `‚ÄúÍ≤Ä‚Äù`Ïù¥ÎùºÍ≥† Í≤ÄÏÉâÏùÑ ÌñàÏßÄÎßå `‚ÄúÍ≤ÄÏÉâÏóîÏßÑ‚Äù`Ïù¥ Ïûò ÎÇòÏò® Í≤ÉÏùÑ Ïïå Ïàò ÏûàÎã§.

---

# ÏûêÎèôÏôÑÏÑ± UI Ïó∞ÎèôÌïòÍ∏∞

## 1. ÏûêÎèôÏôÑÏÑ± Î∂ÑÏÑùÍ∏∞ ÏÑ∏ÌåÖÌïòÍ∏∞ (Custom Analyzer ÎßåÎì§Í∏∞)

- Ïù∏Îç±Ïä§ Îß§Ìïë Ï†ïÏùò + edge_ngram Î∂ÑÏÑùÍ∏∞ ÏÑ§Ï†ï

```java
PUT /autocomplete_index
{
  "settings": {
    "analysis": {
      "tokenizer": {
        "autocomplete_tokenizer": {
          "type": "edge_ngram",
          "min_gram": 1,
          "max_gram": 20,
          "token_chars": ["letter", "digit"]
        }
      },
      "analyzer": {
        "autocomplete_analyzer": {
          "type": "custom",
          "tokenizer": "autocomplete_tokenizer",
          "filter": ["lowercase"]
        },
        "autocomplete_search_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "autocomplete_analyzer",
        "search_analyzer": "autocomplete_search_analyzer"
      }
    }
  }
}

```

- analyzerÍ∞Ä 2Í∞úÏù∏ Ïù¥Ïú†
    - `indexing` Ìï† Îïå ‚Üí `edge_ngram`ÏúºÎ°ú ÏûêÎ•∏Îã§.
    - `Í≤ÄÏÉâ`Ìï† Îïå ‚ÜíÏùºÎ∞ò `standard analyzer`Î°ú Ï†ÑÏ≤¥ Îã®Ïñ¥ Í≤ÄÏÉâ

## 2. Îç∞Ïù¥ÌÑ∞ ÎÑ£Í∏∞ (ÏûêÎèôÏôÑÏÑ±Ïö© title)

```java
POST /autocomplete_index/_doc
{
  "title": "Í≤ÄÏÉâÏóîÏßÑ"
}

POST /autocomplete_index/_doc
{
  "title": "Í≤ÄÏÉâÏñ¥ Ï∂îÏ≤ú"
}

POST /autocomplete_index/_doc
{
  "title": "Í≤ÄÏÉâÏ∞Ω Ïó¥Í∏∞"
}
```

## 3. Í≤ÄÏÉâÏñ¥ prefixÎ°ú ÏûêÎèôÏôÑÏÑ± ÌÖåÏä§Ìä∏

```java
GET /autocomplete_index/_search
{
  "query": {
    "match": {
      "title": {
        "query": "Í≤Ä"
      }
    }
  }
}
```

- Í≤∞Í≥º : `Í≤ÄÏÉâÏóîÏßÑ`, `Í≤ÄÏÉâÏñ¥ Ï∂îÏ≤ú`, `Í≤ÄÏÉâÏñ¥ Ïó¥Í∏∞` Î™®Îëê Í≤ÄÏÉâÎêúÎã§.

```java
{
    "took": 718,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 3,
            "relation": "eq"
        },
        "max_score": 0.14181954,
        "hits": [
            {
                "_index": "autocomplete_index",
                "_type": "_doc",
                "_id": "Nzx7IpYBuHtZHrl3RUGN",
                "_score": 0.14181954,
                "_source": {
                    "title": "Í≤ÄÏÉâÏóîÏßÑ"
                }
            },
            {
                "_index": "autocomplete_index",
                "_type": "_doc",
                "_id": "ODx7IpYBuHtZHrl3bUGd",
                "_score": 0.12974027,
                "_source": {
                    "title": "Í≤ÄÏÉâÏñ¥ Ï∂îÏ≤ú"
                }
            },
            {
                "_index": "autocomplete_index",
                "_type": "_doc",
                "_id": "OTx7IpYBuHtZHrl3fUES",
                "_score": 0.12974027,
                "_source": {
                    "title": "Í≤ÄÏÉâÏñ¥ Ïó¥Í∏∞"
                }
            }
        ]
    }
}
```

- ÎßåÏïΩÏóê ‚ÄúÏÉâ‚Äù ÌòπÏùÄ Îã§Î•∏ Îã®Ïñ¥Î°ú Í≤ÄÏÉâÏùÑ ÌïòÎ©¥ Í≤∞Í≥ºÍ∞Ä Ïïà ÎÇòÏò®Îã§.

```java
{
  "query": {
    "match": {
      "title": "ÏÉâ"
    }
  }
}
-- Í≤∞Í≥º
{
    "took": 2,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 0,
            "relation": "eq"
        },
        "max_score": null,
        "hits": []
    }
}
```

## 4. Spring Boot Í≤ÄÏÉâ API ÎßåÎì§Í∏∞

`SearchController.java`

‚áí Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏Î•º ÏúÑÌïú Íµ¨ÌòÑÏù¥Í∏∞ ÎïåÎ¨∏Ïóê conrollerÏóêÏÑú Îã§ Íµ¨ÌòÑ

```java
package com.example.learnspringboot.controller;

import co.elastic.clients.elasticsearch.ElasticsearchClient;
import co.elastic.clients.elasticsearch.core.SearchResponse;
import com.example.learnspringboot.entity.Post;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@RestController
@RequestMapping("/search")
@RequiredArgsConstructor
public class SearchController {

    private final ElasticsearchClient elasticsearchClient;

    @GetMapping("/autocomplete")
    public List<String> autocomplete(@RequestParam String prefix) throws IOException {
        SearchResponse<Post> response = elasticsearchClient.search(s -> s
                        .index("autocomplete_index") // Íº≠ PostmanÏóê ÎßûÏ∂∞Ïïº Ìï®!
                        .query(q -> q
                                .match(m -> m
                                        .field("title")
                                        .query(prefix)
                                )
                        )
                        .size(10),
                Post.class
        );

        return response.hits().hits()
                .stream()
                .map(hit -> hit.source().getTitle())
                .toList();
    }
}

```

## 5. ConfigÎì§

Config ÏÑ§Ï†ïÏùÑ ÏûòÎ™ªÌïòÎ©¥ Ï∂©ÎèåÏù¥ ÏùºÏñ¥ÎÇúÎã§.

- WebConfig

```java
package com.example.learnspringboot.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("*")  // Í∞úÎ∞úÏö©ÏúºÎ°ú Î™®Îì† origin ÌóàÏö© (Î∞∞Ìè¨ ÏãúÏóêÎäî ÎèÑÎ©îÏù∏ ÏßÄÏ†ï)
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*");
	    }
    }
```

- JpaConfig

```java
package com.example.learnspringboot.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

@Configuration
@EnableJpaRepositories(
        basePackages = "com.example.learnspringboot.repository.jpa"
)
public class JpaConfig {
}
```

- ElasticConfig

```java
package com.example.learnspringboot.config;

import co.elastic.clients.elasticsearch.ElasticsearchClient;
import co.elastic.clients.json.jackson.JacksonJsonpMapper;
import co.elastic.clients.transport.ElasticsearchTransport;
import co.elastic.clients.transport.rest_client.RestClientTransport;
import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.elasticsearch.repository.config.EnableElasticsearchRepositories;

@Configuration
@EnableElasticsearchRepositories(
        basePackages = "com.example.learnspringboot.repository.elastic"
)
public class ElasticsearchConfig {

    @Value("${spring.elasticsearch.uris}")
    private String elasticsearchUrl;

    @Bean
    public ElasticsearchClient elasticsearchClient() {
        RestClient restClient = RestClient.builder(HttpHost.create(elasticsearchUrl)).build();
        ElasticsearchTransport transport = new RestClientTransport(restClient, new JacksonJsonpMapper());
        return new ElasticsearchClient(transport);
    }
}

```

## 5. Html

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image.png)

```java
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Elasticsearch ÏûêÎèôÏôÑÏÑ±</title>
    <style>
        input {
            padding: 8px;
            font-size: 16px;
        }

        ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 8px;
            border: 1px solid #ccc;
            max-width: 250px;
        }

        li {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        li:last-child {
            border-bottom: none;
        }

        li:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
<h2>ÏûêÎèôÏôÑÏÑ± Í≤ÄÏÉâ</h2>
<input type="text" id="searchInput" placeholder="Ï†úÎ™© ÏûÖÎ†•">
<ul id="resultList"></ul>

<script>
    let timeout = null;

    document.getElementById("searchInput").addEventListener("input", function () {
        clearTimeout(timeout);
        const query = this.value.trim();
        const list = document.getElementById("resultList");
        list.innerHTML = "";

        if (query.length < 1) {
            return; // 1Í∏ÄÏûê Ïù¥ÏÉÅ ÏûÖÎ†• ÏãúÎßå Í≤ÄÏÉâ
        }

        timeout = setTimeout(async () => {
            try {
                const res = await fetch(`/search/autocomplete?prefix=${encodeURIComponent(query)}`);
                const data = await res.json();

                if (!Array.isArray(data)) {
                    throw new Error("ÏùëÎãµ ÌòïÏãù Ïò§Î•ò");
                }

                data.forEach(title => {
                    const li = document.createElement("li");
                    li.textContent = title;
                    li.onclick = () => {
                        document.getElementById("searchInput").value = title;
                        list.innerHTML = "";
                    };
                    list.appendChild(li);
                });
            } catch (e) {
                const li = document.createElement("li");
                li.textContent = "üî¥ Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù";
                li.style.color = "red";
                list.appendChild(li);
                console.error(e);
            }
        }, 300); // debounce: 300ms ÏûÖÎ†• Î©àÏ∂§ ÌõÑ ÏöîÏ≤≠
    });
</script>
</body>
</html>

```

# ÌïòÏù¥ÎùºÏù¥ÌåÖ (Highlighting)

title Í≤ÄÏÉâ Ïãú, ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÌÇ§ÏõåÎìúÍ∞Ä Í≤∞Í≥ºÏóêÏÑú Í∞ïÏ°∞ÎêòÏñ¥ Î≥¥Ïù¥ÎèÑÎ°ù ÎßåÎì§Í∏∞

- Ïö∞Î¶¨Í∞Ä Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú  Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÎ©¥ Ï∂îÏ≤ú Í≤ÄÏÉâÏñ¥Ïóê Ïö∞Î¶¨Í∞Ä ÏûÖÎ†•Ìïú Í∏ÄÏûêÏôÄ ÏùºÏπòÌïòÎäî Ï∂îÏ≤ú Í≤ÄÏÉâÏñ¥Îäî ÏßÑÌïú Í∏ÄÏî®Ï≤¥Î°ú Î≥¥Ïù¥Í±∞ÎÇò Îã§Î•∏ÏÉâÏúºÎ°ú ÌëúÏãúÌï¥Ï§ÄÎã§ Ïù¥ Í∏∞Îä•ÏùÑ Íµ¨ÌòÑÌïú Í≤ÉÏù¥Îã§
- HOW?
    - ÏûÖÎ†•Ìïú textÎäî <em> ÌÉúÍ∑∏Í∞Ä Î∂ôÏñ¥ Í∞ïÏ°∞Ìö®Í≥ºÍ∞Ä Ï†ÅÏö©Ïù¥ ÎêúÎã§.

Ïòà)

```java
ÏûÖÎ†•: "ÍπÄ"
Í≤∞Í≥º: "‚ü™<em>ÍπÄ</em>ÏπòÎ≥∂ÏùåÎ∞•‚ü´", "‚ü™<em>ÍπÄ</em>Î∞•Ï≤úÍµ≠‚ü´"
```

## 1. Controller Ï∂îÍ∞Ä

```java
 @GetMapping("/highlight")
    public List<String> searchWithHighlight(@RequestParam String keyword) throws IOException {
        SearchResponse<Post> response = elasticsearchClient.search(s -> s
                        .index("posts")
                        .query(q -> q
                                .match(m -> m
                                        .field("title")
                                        .query(keyword)
                                )
                        )
                        .highlight(h -> h
                                .fields("title", f -> f
                                        .preTags("<em>")
                                        .postTags("</em>")
                                )
                        ),
                Post.class
        );

        List<String> results = new ArrayList<>();
        for (Hit<Post> hit : response.hits().hits()) {
            String highlighted;             // fallback
            
            // highlightÎêú Î∂ÄÎ∂Ñ ÏÇ¨Ïö©
            if (hit.highlight().get("title") != null) {
                highlighted = hit.highlight().get("title").get(0);
            } else {
                assert hit.source() != null;
                highlighted = hit.source().getTitle();
            }
            results.add(highlighted);
        }

        return results;
    }
```

## HTML ÏàòÏ†ï

```java
<input type="text" id="highlightInput" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•">
<ul id="highlightResult"></ul>

<script>
    document.getElementById("highlightInput").addEventListener("input", async (e) => {
        const keyword = e.target.value;
        const res = await fetch(`/search/highlight?keyword=${keyword}`);
        const data = await res.json();

        const resultList = document.getElementById("highlightResult");
        resultList.innerHTML = "";

        data.forEach(text => {
            const li = document.createElement("li");
            li.innerHTML = text;  // ‚ú® highlight Î∂ÄÎ∂Ñ <em> ÌÉúÍ∑∏ Ï†ÅÏö©
            resultList.appendChild(li);
        });
    });
</script>

```

## Í≤∞Í≥º

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image%201.png)

- ÌòÑÏû¨Îäî ÌïòÏù¥ÎùºÏù¥ÌåÖÏùÑ Ï†ÅÏö©ÏùÑ ÌñàÎã§
- ÎßåÏïΩ Îã§Î•∏ Í∞ïÏ°∞Ìö®Í≥ºÎ•º Ï£ºÍ≥† Ïã∂ÏúºÎ©¥ Îã§Î•∏ ÌÉúÍ∑∏Î•º Ï†ÅÏö©ÌïòÎ©¥ ÎêúÎã§.

---

# Í≤ÄÏÉâ Í≤∞Í≥º Ï†ïÎ†¨

Í∏∞Î≥∏Ï†ÅÏúºÎ°ú match ÏøºÎ¶¨Îäî _score ÏàúÏÑú (= relevance Í∏∞Î∞ò ) Î°ú Ï†ïÎ†¨ÎêúÎã§.

ÌïòÏßÄÎßå ÌïÑÏöîÏóê Îî∞Îùº ÎÇ†ÏßúÏàú, Ï°∞ÌöåÏàú, ÏïåÌååÎ≤≥Ïàú Îì±ÏúºÎ°ú Ï†ïÎ†¨Ïù¥ Í∞ÄÎä•ÌïòÎã§.

## 1. Entity ÏàòÏ†ï

- Ïö∞Î¶¨Îäî ÏµúÏã†ÏàúÍ≥º Ï°∞ÌöåÏàòÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÎäî Í≤ÉÏùÑ Ìï† Í≤ÉÏù¥Îã§

```java
package com.example.learnspringboot.entity;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import lombok.*;
import org.springframework.data.elasticsearch.annotations.Document;

@Entity
@Getter @Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@JsonIgnoreProperties(ignoreUnknown = true)
@Document(indexName = "posts")
public class Post {
    @Id
    private String id;
    private String title;
    private String content;
    private int views;
    private String createdAt;
}

```

- Í∏∞Ï°¥ Elasticsearch IndexÎäî ÏÇ≠Ï†úÌï¥Ïïº ÌïúÎã§.

```java
DELETE http://localhost:9200/autocomplete_index/
```

- Î≥ÄÍ≤ΩÎêú EntityÏóê ÎßûÍ≤å ÏÉàÎ°úÏö¥ Ïù∏Îç±Ïä§Î•º ÏÉùÏÑ±ÌïúÎã§.

```java
PUT http://localhost:9200/autocomplete_index

{
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "views": {
        "type": "integer"
      },
      "createdAt": {
        "type": "date"
      },
      "content": {
        "type": "text"
      },
      "id": {
        "type": "keyword"
      }
    }
  }
}

```

## 2. Controller Ï∂îÍ∞Ä

```java
    @GetMapping("/sorted")
    public List<String> sortedSearch(
            @RequestParam String keyword,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String direction
    ) throws IOException {

        // Elasticsearch Ï†ïÎ†¨ ÏøºÎ¶¨ Ïã§Ìñâ
        SearchResponse<Post> response = elasticsearchClient.search(s -> s
                        .index("autocomplete_index") 
                        .query(q -> q
                                .match(m -> m
                                        .field("title")
                                        .query(keyword)
                                )
                        )
                        .sort(so -> so
                                .field(f -> f
                                        .field(sortBy)
                                        .order("asc".equalsIgnoreCase(direction)
                                                ? SortOrder.Asc
                                                : SortOrder.Desc)
                                )
                        )
                        .size(10),
                Post.class
        );

        // Í≤∞Í≥º Î∞òÌôò: title Î™©Î°ù
        return response.hits().hits().stream()
                .map(hit -> hit.source().getTitle())
                .toList();
    }

```

## 3. HTML

```java
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ï†ïÎ†¨ Í≤ÄÏÉâ</title>
    <style>
        input, select {
            padding: 8px;
            margin: 4px;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            padding: 6px;
        }
    </style>
</head>
<body>
<h2>Ï†ïÎ†¨ Í∏∞Î∞ò Í≤ÄÏÉâ</h2>

<input id="keyword" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•">
<select id="sortBy">
    <option value="title">Ï†úÎ™©(title)</option>
    <option value="views">Ï°∞ÌöåÏàò(views)</option>
    <option value="createdAt">ÏûëÏÑ±Ïùº(createdAt)</option>
</select>
<select id="direction">
    <option value="asc">Ïò§Î¶ÑÏ∞®Ïàú(asc)</option>
    <option value="desc">ÎÇ¥Î¶ºÏ∞®Ïàú(desc)</option>
</select>
<button onclick="sortedSearch()">Í≤ÄÏÉâ</button>

<ul id="resultList"></ul>

<script>
    async function sortedSearch() {
        const keyword = document.getElementById("keyword").value;
        const sortBy = document.getElementById("sortBy").value;
        const direction = document.getElementById("direction").value;
        const resultList = document.getElementById("resultList");
        resultList.innerHTML = "";

        try {
            const res = await fetch(`/search/sorted?keyword=${encodeURIComponent(keyword)}&sortBy=${sortBy}&direction=${direction}`);
            const data = await res.json();

            if (!Array.isArray(data)) {
                throw new Error("ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù¥ ÏïÑÎãò: " + JSON.stringify(data));
            }

            data.forEach(title => {
                const li = document.createElement("li");
                li.textContent = title;
                resultList.appendChild(li);
            });
        } catch (err) {
            const li = document.createElement("li");
            li.textContent = "üî¥ Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù";
            li.style.color = "red";
            resultList.appendChild(li);
            console.error(err);
        }
    }
</script>

</body>
</html>

```

## Í≤∞Í≥º

- ÏõêÌïòÎäîÎåÄÎ°ú Ï†ïÎ†¨Ïù¥ ÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÎã§

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image%202.png)

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image%203.png)

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image%204.png)

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image%205.png)

# ÌéòÏù¥Ïßï Ï≤òÎ¶¨

## 1. Controller

```java
    @GetMapping("/paged")
    public List<String> pagedSearch(
            @RequestParam String keyword,                      // Í≤ÄÏÉâÌï† ÌÇ§ÏõåÎìú (title ÌïÑÎìú Í∏∞Ï§Ä)
            @RequestParam(defaultValue = "0") int page,        // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Î≤àÌò∏ (0Î∂ÄÌÑ∞ ÏãúÏûë)
            @RequestParam(defaultValue = "10") int size,       // Ìïú ÌéòÏù¥ÏßÄÏóê Î≥¥Ïó¨Ï§Ñ Î¨∏ÏÑú Ïàò
            @RequestParam(defaultValue = "createdAt") String sortBy, // Ï†ïÎ†¨Ìï† ÌïÑÎìú (Ïòà: createdAt, title Îì±)
            @RequestParam(defaultValue = "desc") String direction     // Ï†ïÎ†¨ Î∞©Ìñ• (asc or desc)
    ) throws IOException {

        // ElasticsearchÏóêÏÑú ÏÇ¨Ïö©Ìï† from Í∞í Í≥ÑÏÇ∞ (ÌéòÏù¥ÏßÄ * ÏÇ¨Ïù¥Ï¶à)
        int from = page * size;

        // Elasticsearch Í≤ÄÏÉâ ÏöîÏ≤≠ ÏàòÌñâ
        SearchResponse<Post> response = elasticsearchClient.search(s -> s
                        .index("autocomplete_index")         // Í≤ÄÏÉâ ÎåÄÏÉÅ Ïù∏Îç±Ïä§ (Ïã§Ï†ú Ïù∏Îç±Ïä§Î™Ö ÏÇ¨Ïö©!)
                        .from(from)                          // Î™á Î≤àÏß∏Î∂ÄÌÑ∞ ÏãúÏûëÌï†ÏßÄ ÏßÄÏ†ï (ÌéòÏù¥Ïßï)
                        .size(size)                          // Ìïú Î≤àÏóê Í∞ÄÏ†∏Ïò¨ Î¨∏ÏÑú Ïàò
                        .query(q -> q                        // Í≤ÄÏÉâ ÏøºÎ¶¨ Ï†ïÏùò
                                .match(m -> m
                                        .field("title")      // title ÌïÑÎìúÎ•º Í∏∞Ï§ÄÏúºÎ°ú
                                        .query(keyword)      // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÌÇ§ÏõåÎìúÎ°ú match Í≤ÄÏÉâ
                                )
                        )
                        .sort(so -> so                       // Ï†ïÎ†¨ Ï°∞Í±¥ Ï†ïÏùò
                                .field(f -> f
                                        .field(sortBy)       // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú ÌïÑÎìúÎ°ú Ï†ïÎ†¨
                                        .order("asc".equalsIgnoreCase(direction) // Ï†ïÎ†¨ Î∞©Ìñ• ÏÑ§Ï†ï
                                                ? SortOrder.Asc
                                                : SortOrder.Desc)
                                )
                        ),
                Post.class // Í≤∞Í≥ºÎ•º Îß§ÌïëÌï† ÌÅ¥ÎûòÏä§ ÏßÄÏ†ï
        );

        // Í≤ÄÏÉâ Í≤∞Í≥ºÏóêÏÑú Post Í∞ùÏ≤¥Ïùò title ÌïÑÎìúÎßå Ï∂îÏ∂úÌïòÏó¨ Î∞òÌôò
        List<String> results = response.hits().hits().stream()
                .map(hit -> hit.source().getTitle())
                .toList();

        return results;
    }
```

## 2. HTML

```java
<h2>ÌéòÏù¥Ïßï Í≤ÄÏÉâ</h2>
<input id="keyword" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•">
<select id="sortBy">
    <option value="title">Ï†úÎ™©(title)</option>
    <option value="views">Ï°∞ÌöåÏàò(views)</option>
    <option value="createdAt">ÏûëÏÑ±Ïùº(createdAt)</option>
</select>
<select id="direction">
    <option value="asc">Ïò§Î¶ÑÏ∞®Ïàú(asc)</option>
    <option value="desc">ÎÇ¥Î¶ºÏ∞®Ïàú(desc)</option>
</select>
<input id="page" type="number" value="0" min="0" style="width:60px" />
<input id="size" type="number" value="10" min="1" style="width:60px" />
<button onclick="pagedSearch()">Í≤ÄÏÉâ</button>

<ul id="resultList"></ul>

<script>
    async function pagedSearch() {
        const keyword = document.getElementById("keyword").value;
        const sortBy = document.getElementById("sortBy").value;
        const direction = document.getElementById("direction").value;
        const page = document.getElementById("page").value;
        const size = document.getElementById("size").value;
        const resultList = document.getElementById("resultList");
        resultList.innerHTML = "";

        try {
            const res = await fetch(`/search/paged?keyword=${encodeURIComponent(keyword)}&sortBy=${sortBy}&direction=${direction}&page=${page}&size=${size}`);
            const data = await res.json();

            if (!Array.isArray(data)) {
                throw new Error("ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù¥ ÏïÑÎãò: " + JSON.stringify(data));
            }

            data.forEach(title => {
                const li = document.createElement("li");
                li.textContent = title;
                resultList.appendChild(li);
            });
        } catch (err) {
            const li = document.createElement("li");
            li.textContent = "üî¥ Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù";
            li.style.color = "red";
            resultList.appendChild(li);
            console.error(err);
        }
    }
</script>

```

# Îã§Ï§ë ÌïÑÎìú Í≤ÄÏÉâ

- ÌïòÎÇòÏùò Í≤ÄÏÉâÏñ¥Î°ú `title`, `content` Îëê ÌïÑÎìúÎ•º ÎèôÏãúÏóê Í≤ÄÏÉâÌïòÎäî Í∏∞Îä•!

```java
    @GetMapping("/multifield")
    public List<String> multiFieldSearch(
            @RequestParam String keyword
    ) throws IOException {
        // Elasticsearch multi_match ÏøºÎ¶¨
        SearchResponse<Post> response = elasticsearchClient.search(s -> s
                        .index("autocomplete_index") // ÏÇ¨Ïö© Ï§ëÏù∏ Ïù∏Îç±Ïä§ Ïù¥Î¶Ñ
                        .query(q -> q
                                .multiMatch(m -> m
                                        .query(keyword)                         // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú Í≤ÄÏÉâÏñ¥
                                        .fields("title", "content")             // ÎèôÏãúÏóê Í≤ÄÏÉâÌï† ÌïÑÎìúÎì§
                                )
                        )
                        .size(10),
                Post.class
        );

        // Í≤ÄÏÉâ Í≤∞Í≥ºÏóêÏÑú titleÎßå Î¶¨Ïä§Ìä∏Î°ú Ï∂îÏ∂ú
        return response.hits().hits().stream()
                .map(hit -> hit.source().getTitle())
                .toList();
    }
```

# Í∞ÄÏ§ëÏπò Í≤ÄÏÉâ - boots Ï†ÅÏö©

- `multi_match` Í≤ÄÏÉâÏãú `title` ÌïÑÎìúÏóê Îçî ÎÜíÏùÄ Ï†êÏàòÎ•º Î∂ÄÏó¨ ‚Üí Í≤ÄÏÉâ Í≤∞Í≥ºÏùò `Ïö∞ÏÑ†ÏàúÏúÑ`Î•º Ï°∞Ï†àÌï®

```java
@GetMapping("/boost")
public List<String> boostedSearch(@RequestParam String keyword) throws IOException {
    SearchResponse<Post> response = elasticsearchClient.search(s -> s
                    .index("autocomplete_index")
                    .query(q -> q
                            .multiMatch(m -> m
                                    .query(keyword)
                                    .fields("title^3", "content") // titleÏóê 3Î∞∞ Í∞ÄÏ§ëÏπò Ï†ÅÏö©
                            )
                    )
                    .size(10),
            Post.class
    );

    return response.hits().hits().stream()
            .map(hit -> hit.source().getTitle())
            .toList();
}

```

- must : Í≤ÄÏÉâ Ï°∞Í±¥ (Í≤ÄÏÉâÏñ¥)
- filter : Í≤∞Í≥º Ï†úÌïú (Ï°∞ÌöåÏàò, ÎÇ†Ïßú Îì±)
- should : Ï†êÏàò Ïò¨Î†§Ï£ºÎäî Ï°∞Í±¥ (ÏÑ†ÌÉùÏ†Å boost)
- must_not  : Ï†úÏô∏ Ï°∞Í±¥

# Ï°∞ÌöåÏàò ÌïÑÌÑ∞ÎßÅ

- Ï°∞ÌöåÏàòÍ∞Ä ÏùºÏ†ï ÏàòÏπò Ïù¥ÏÉÅÏù∏ Î¨∏ÏÑúÎßå Í≤ÄÏÉâ

```java
@GetMapping("/popular")
public List<String> popularSearch(@RequestParam String keyword) throws IOException {
    SearchResponse<Post> response = elasticsearchClient.search(s -> s
                    .index("autocomplete_index")
                    .query(q -> q
                            .bool(b -> b
                                    .must(m -> m
                                            .multiMatch(mm -> mm
                                                    .query(keyword)
                                                    .fields("title", "content")
                                            )
                                    )
                                    .filter(f -> f
                                            .range(r -> r
                                                    .field("views")
                                                    .gt("100") // Ï°∞ÌöåÏàò 100 Ï¥àÍ≥º Ï°∞Í±¥
                                            )
                                    )
                            )
                    )
                    .size(10),
            Post.class
    );

    return response.hits().hits().stream()
            .map(hit -> hit.source().getTitle())
            .toList();
}

```

# ÎÇ†Ïßú ÌïÑÌÑ∞ÎßÅ

- Î¨∏ÏÑúÏùò createdAt ÎÇ†ÏßúÍ∞Ä ÏµúÍ∑º 30Ïùº Ïù¥ÎÇ¥Ïù∏ Í≤ΩÏö∞Îßå Í≤ÄÏÉâ
    - `range` ÏøºÎ¶¨ ÏÇ¨Ïö©
- `createdAt` Ïù¥ Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå date Ìè¨Îß∑(yyyy-mm-dd)ÏúºÎ°ú Ïù∏Îç±Ïã±ÎêòÏñ¥ ÏûàÏñ¥Ïïº Ìï®

```java
@GetMapping("/recent")
public List<String> recentSearch(@RequestParam String keyword) throws IOException {
    // Ïò§Îäò ÎÇ†Ïßú Í∏∞Ï§ÄÏúºÎ°ú 30Ïùº Ï†Ñ ÎÇ†Ïßú Í≥ÑÏÇ∞
    String thirtyDaysAgo = java.time.LocalDate.now().minusDays(30).toString(); // Ïòà: "2024-03-15"

    SearchResponse<Post> response = elasticsearchClient.search(s -> s
                    .index("autocomplete_index")
                    .query(q -> q
                            .bool(b -> b
                                    .must(m -> m
                                            .multiMatch(mm -> mm
                                                    .query(keyword)
                                                    .fields("title", "content")
                                            )
                                    )
                                    .filter(f -> f
                                            .range(r -> r
                                                    .field("createdAt")
                                                    .gte(thirtyDaysAgo) // ÏµúÍ∑º 30ÏùºÎßå
                                            )
                                    )
                            )
                    )
                    .size(10),
            Post.class
    );

    return response.hits().hits().stream()
            .map(hit -> hit.source().getTitle())
            .toList();
}

```

# Î≥µÌï© Ï°∞Í±¥ Í≤ÄÏÉâ API

1. `multi_match` : `title`Í≥º `content` ÎèôÏãú Í≤ÄÏÉâ
2. `boost` : `title ^ 2` Í∞ÄÏ§ëÏπò Ï†ÅÏö©
3. `Ï°∞ÌöåÏàò ÌïÑÌÑ∞` : `views` > 100
4. `ÎÇ†Ïßú ÌïÑÌÑ∞` : ÏµúÍ∑º 30Ïùº (`createdAt` ‚â• `today` - 30Ïùº)
5. `Ï†ïÎ†¨` : `views` ÎÇ¥Î¶ºÏ∞®Ïàú

```java
@GetMapping("/complex")
public List<String> complexSearch(
        @RequestParam String keyword
) throws IOException {
    // ÏµúÍ∑º 30Ïùº Í∏∞Ï§Ä ÎÇ†Ïßú Í≥ÑÏÇ∞
    String thirtyDaysAgo = java.time.LocalDate.now().minusDays(30).toString();

    SearchResponse<Post> response = elasticsearchClient.search(s -> s
                    .index("autocomplete_index")
                    .query(q -> q
                            .bool(b -> b
                                    // ÌïÑÏàò Í≤ÄÏÉâÏñ¥ Ï°∞Í±¥ (multi_match + boost)
                                    .must(m -> m
                                            .multiMatch(mm -> mm
                                                    .query(keyword)
                                                    .fields("title^2", "content") // titleÏóê Í∞ÄÏ§ëÏπò 2
                                            )
                                    )
                                    // Ï°∞ÌöåÏàò ÌïÑÌÑ∞
                                    .filter(f -> f
                                            .range(r -> r
                                                    .field("views")
                                                    .gt("100") // 100 Ï¥àÍ≥º
                                            )
                                    )
                                    // ÎÇ†Ïßú ÌïÑÌÑ∞ (ÏµúÍ∑º 30Ïùº Ïù¥ÎÇ¥)
                                    .filter(f -> f
                                            .range(r -> r
                                                    .field("createdAt")
                                                    .gte(thirtyDaysAgo) // 30Ïùº Ï†ÑÎ∂ÄÌÑ∞ Ïò§ÎäòÍπåÏßÄ
                                            )
                                    )
                            )
                    )
                    // Ï°∞ÌöåÏàò Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
                    .sort(so -> so
                            .field(f -> f
                                    .field("views")
                                    .order(SortOrder.Desc)
                            )
                    )
                    .size(10),
            Post.class
    );

    // Í≤∞Í≥ºÏóêÏÑú title ÌïÑÎìúÎßå Ï∂îÏ∂úÌïòÏó¨ Î∞òÌôò
    return response.hits().hits().stream()
            .map(hit -> hit.source().getTitle())
            .toList();
}

```

---

- Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ

```
{
  "id": "1111",
  "title": "Elasticsearch Boost Ï†ÅÏö©ÌïòÍ∏∞",
  "content": "title ÌïÑÎìúÏóê Í∞ÄÏ§ëÏπòÎ•º ÏÑ§Ï†ïÌï¥ÏÑú Í≤ÄÏÉâ Ï†ïÌôïÎèÑÎ•º ÎÜíÏù∏Îã§",
  "views": 150,
  "createdAt": "2025-04-10"
}

```

```
{
  "id": "1112",
  "title": "Spring Data Elasticsearch ÏôÑÏ†Ñ Ï†ïÎ≥µ",
  "content": "ElasticsearchÏóê ÎåÄÌïú ÎÇ¥Ïö©ÏùÄ contentÏóêÎèÑ Ìè¨Ìï®",
  "views": 90,
  "createdAt": "2025-03-05"
}

```

```java

{
  "id": "1113",
  "title": "Ïù∏Í∏∞ Í≤åÏãúÍ∏Ä Top10",
  "content": "Ï°∞ÌöåÏàòÍ∞Ä ÎÜíÏùÄ Í≤åÏãúÍ∏ÄÎßå Î™®ÏïòÏäµÎãàÎã§",
  "views": 500,
  "createdAt": "2025-03-20"
}

```

---

- Í≤∞Í≥º
    - `title Í∞ÄÏ§ëÏπò`ÏôÄ `ÏµúÍ∑º 30Ïùº`Ïóê ÏûëÏÑ±Îêú Í≤åÏãúÍ∏Ä Í∑∏Î¶¨Í≥† `Ï°∞ÌöåÏàò`Î•º Î™®Îëê ÎπÑÍµêÌï¥Î≥¥ÏïòÏùÑ Îïå ÏûÖÎ†•Ìïú Îç∞Ïù¥ÌÑ∞ Ï§ë Ï∂©Ï°±ÌïòÎäî ÌïòÎÇòÏùò Í≤∞Í≥ºÍ∞Ä ÎÇòÏôîÎã§

![image.png](%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%80%E1%85%B3%E1%86%B8%201d281d8a13f0800ca4ccd54d47ceae9e/image%206.png)
