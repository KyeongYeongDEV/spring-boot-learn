# Ï¥àÍ∏â

# ElasticSearchÎûÄ?

> ÎèÑÏÑúÍ¥Ä ÏÇ¨ÏÑú ÏÑ†ÏÉùÎãòÏù¥Îã§
> 
- Ï±ÖÏù¥ ÏàòÏ≤ú Í∂åÏù¥ ÏûàÏñ¥ÎèÑ Ï†úÎ™©Ïù¥ÎÇò ÏûëÍ∞Ä Ïù¥Î¶ÑÏúºÎ°ú `ÏàúÏãùÍ∞ÑÏóê Ï∞æÏïÑÏ£ºÎäî` ÏïÑÏ£º ÎòëÎòëÌïú ÏÇ¨ÏÑúÏù¥Îã§
- Ïù¥ ÏÇ¨ÏÑúÎäî  Ï±ÖÏùÑ Ïñ¥ÎñªÍ≤å Ï∞æÏïÑÏïº ÏïåÍ≥† ÏûàÏñ¥ÏÑú, Ïö∞Î¶¨Í∞Ä Î¨ºÏñ¥Î≥¥Î©¥ `‚ÄúÎπ®Í∞Ñ Î™®Ïûê‚Äù` Ïù¥ÏïºÍ∏∞ Ï§ë Ï†úÎ™©Ïóê Îπ®Í∞ÑÏù¥ Îì§Ïñ¥Í∞Ñ Í±∏ Í∏àÎ∞© Ï∞æÏïÑÏ§ÄÎã§.
- Ïù¥Í≤ÉÏù¥ ElasticSearchÏùò `Í≤ÄÏÉâ Í∏∞Îä•`Ïù¥Îã§

---

# Í∞úÎÖê

`document` : ÌïòÎÇòÏùò Îç∞Ïù¥ÌÑ∞ ‚áí Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∞ùÏ≤¥ (Ïòà : Í≤åÏãúÍ∏Ä ÌïòÎÇò)

`Index` : Ï±ÖÏû•  ‚áí Î¨∏ÏÑúÎì§ÏùÑ Ï†ÄÏû•ÌïòÎäî Í≥µÍ∞Ñ

`Field` : Î¨∏ÏÑúÏùò ÏÜçÏÑ± ‚áí Ï†úÎ™©, ÎÇ¥Ïö©, ÏûëÏÑ±Ïûê Îì±

`Mapping` : Î¨∏ÏÑúÏùò Íµ¨Ï°∞ Ï†ïÏùòÏÑú ‚áí ÏÑ§Í≥ÑÎèÑ

`Query` :  ÏÇ¨ÏÑúÏóêÍ≤å ÌïòÎäî ÏßàÎ¨∏ ‚áí Í≤ÄÏÉâ Ï°∞Í±¥

`Match` : Analyzer(Î∂ÑÏÑùÍ∏∞)Î•º ÌÜµÌï¥ ÎÇòÎàà Îã®Ïñ¥ Í∏∞Ï§ÄÏúºÎ°ú Í≤ÄÏÉâ ‚áí ÏûêÏó∞Ïñ¥ Í≤ÄÏÉâ

`Term` : Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäî Í∞íÏùÑ Ï∞æÏùå (Î∂ÑÏÑù x) ‚áí Ï†ïÌôïÌïú ÌÇ§ÏõåÎìú Îß§Ïπ≠

`Bool` : Ïó¨Îü¨ ÏøºÎ¶¨Î•º Ï°∞Ìï©Ìï¥ÏÑú Ï°∞Í±¥ Í≤ÄÏÉâ 

`must` : AND

`should` : OR (ÏÑ†ÌÉùÏ†ÅÏúºÎ°ú ÎßåÏ°±ÌïòÎ©¥ Ï†êÏàò ‚Üë)

`must_not` : Ï†úÏô∏ Ï°∞Í±¥

`filter` : Ï†êÏàò ÏòÅÌñ• ÏóÜÏù¥ Ï°∞Í±¥ ÌïÑÌÑ∞ÎßÅ

---

# API Ï†ïÎ¶¨

| Î©îÏÑúÎìú | URL | ÏÑ§Î™Ö |
| --- | --- | --- |
| PUT / POST | `/{index}` | Ïù∏Îç±Ïä§ ÏÉùÏÑ± |
| DELETE | `/{index}` | Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú |
| POST | `/{index}/_doc` | Î¨∏ÏÑú Ï∂îÍ∞Ä(ID ÏûêÎèô ÏÉùÏÑ±) |
| PUT | `/{index}/_doc/{id}` | Î¨∏ÏÑú Ï∂îÍ∞Ä ÎòêÎäî ÏàòÏ†ï (ID ÏßÄÏ†ï) |
| GET | `/{index}/_doc/{id}` | ÌäπÏ†ï Î¨∏ÏÑú Ï°∞Ìöå |
| DELETE | `/{index}/_doc/{id}` | ÌäπÏ†ï Î¨∏ÏÑú ÏÇ≠Ï†ú |
| GET / POST | `/{index}/_search` | Î¨∏ÏÑú Í≤ÄÏÉâ |
| GET | `/_cat/indices?v` | Î™®Îì† Ïù∏Îç±Ïä§ Î≥¥Í∏∞ (Ïù∏Îç±Ïä§ Ïπ¥ÌÉàÎ°úÍ∑∏) |
| GET | `/_cat/health?v` | ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÉÅÌÉú ÌôïÏù∏ |
| GET | `/{index}/_mapping` | Ïù∏Îç∞Ïä§ ÌïÑÎìú Íµ¨Ï°∞ ÌôïÏù∏ |

---

# Ïã§Ïäµ

> Ïö∞Î¶¨ Í≤åÏãúÍ∏Ä PostÎ•º ElasticSearchÏóê ÎÑ£ÎäîÎã§Í≥† Í∞ÄÏ†ï
> 

## 0. ÎèÑÏª§ Íµ¨ÏÑ±

- ÌòÑÏû¨ KafkaÎèÑ Í∞ôÏù¥ ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÍ∏∞ ÎïåÎ¨∏Ïóê Í∞ôÏù¥ ÏûàÎã§
- Elasticsearch Îßå ÏÇ¨Ïö©Ìï† Í±∞Î©¥ KibanaÏôÄ Elasticsearch ÏÑ§Ï†ïÎßå ÌïòÎ©¥ ÎêúÎã§.

```java
version: '3'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka1:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka1
    container_name: kafka1
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka1:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    depends_on:
      - zookeeper

  kafka2:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka2
    container_name: kafka2
    ports:
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka2:29093,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:29093,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    depends_on:
      - zookeeper

  kafka3:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka3
    container_name: kafka3
    ports:
      - "9094:9094"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka3:29094,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3:29094,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    depends_on:
      - zookeeper

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    networks:
      - elk

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.9
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - elk

networks:
  elk:
    driver: bridge

```

## 1. ÏùòÏ°¥ÏÑ± Ï∂îÍ∞Ä (build.gradle)

```groovy
implementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch'
```

- gradle ÏóÖÎç∞Ïù¥Ìä∏ Ìï¥Ï£ºÍ∏∞

## 2. Post EntityÎ•º Elasticsearch Î¨∏ÏÑúÎ°ú Îì±Î°ùÌïòÍ∏∞

```java
package com.example.learnspringboot.entity;

import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;

@Getter @Setter
@NoArgsConstructor @AllArgsConstructor
@Builder
@Document(indexName = "posts") // postsÎùºÎäî Ïù∏Îç±Ïä§Ïóê Ï†ÄÏû•Îê®
public class Post {

    @Id
    private Long id;
    private String title;
    private String content;
}
 
```

## 3. Elasticsearch Ïö© Repository ÎßåÎì§Í∏∞

```java
package com.example.learnspringboot.repository;

import com.example.learnspringboot.entity.Post;
import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;

public interface PostElasticRepository extends ElasticsearchRepository<Post, Long> {
    // title Í≤ÄÏÉâ ÏòàÏãúÎèÑ Í∞ÄÎä•Ìï¥Ïßê
}

```

## 4. Elasticsearch Service ÎßåÎì§Í∏∞

```java
package com.example.learnspringboot.service;

import com.example.learnspringboot.entity.Post;
import com.example.learnspringboot.repository.PostElasticRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class ElasticsearchService {

    private final PostElasticRepository postElasticRepository;

    public void saveToElasticsearch(Post post) {
        postElasticRepository.save(post);
        System.out.println("üîç ElasticsearchÏóê Ï†ÄÏû• ÏôÑÎ£å: " + post.getTitle());
    }
}

```

## 5. PostServiceÏóêÏÑú Ï†ÄÏû•Ïãú ElasticsearchÏóêÎèÑ Ï†ÄÏû•

```java
public Post createPost(Post post) {
    Post savedPost = postRepository.save(post);
    kafkaProducerService.send(savedPost); // Kafka
    elasticsearchService.saveToElasticsearch(savedPost); // Elasticsearch Ï∂îÍ∞Ä
    return savedPost;
}
```

# ÌÖåÏä§Ìä∏ÌïòÍ∏∞

## Kibana

1. Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú [localhost:5601](http://localhost:5601) (Kibana Ï†ëÏÜçÎê®)

![image.png](%E1%84%8E%E1%85%A9%E1%84%80%E1%85%B3%E1%86%B8%201d181d8a13f080b49ccbf15f2b071d0c/image.png)

## ÏÇ¨Ïö© ÏòàÏãú1

1. Ïù∏Îç±Ïä§ ÏÉùÏÑ±

```java
PUT /posts
```

1. Î¨∏ÏÑú Ï†ÄÏû• (ID ÏûêÎèô ÏßÄÏ†ï)

```java
POST /posts/_doc
Content-Type: application/json

{
  "title": "Elastic Î∞∞Ïö∞Í∏∞",
  "content": "ÏâΩÍ≥† Ïû¨ÎØ∏ÏûàÎã§!"
}
```

1. Î¨∏ÏÑú Ï†ÄÏû• (ID ÏßÅÏ†ë ÏßÄÏ†ï urlÏù¥ Îã§Î¶Ñ)

```java
PUT /posts/_doc/1
Content-Type: application/json

{
  "title": "Ï≤´ Î≤àÏß∏ Í∏Ä",
  "content": "Ïö∞Î¶¨Îäî ElasticsearchÎ•º Î∞∞ÏõåÏöî"
}

```

1. Î¨∏ÏÑú Ï°∞Ìöå

```java
GET /posts/_doc/1
```

1. Î¨∏ÏÑú ÏÇ≠Ï†ú

```java
DELETE /posts/_docs/1
```

1. Ï†ÑÏ≤¥ Î¨∏ÏÑú Ï°∞Ìöå

```java
GET /posts/_search

{
  "query": {
    "match_all": {}
  }
}
```

1. Í≤ÄÏÉâ ÏøºÎ¶¨

```java
GET /posts/_search

{
  "query": {
    "match": {
      "title": "Elastic"
    }
  }
}

```

## ÏÇ¨Ïö© ÏòàÏãú2

> match, term, boolÏùÑ Ïù¥Ïö©Ìï¥ Í≤ÄÏÉâÌïòÍ∏∞
> 
- ÏòàÏãú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    
    ```java
    POST http://localhost:9200/posts/_doc
    {
      "title": "ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî ÎÜÄÎùºÏö¥ Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§.",
      "content": "ElasticsearchÎäî Î°úÍ∑∏ Î∂ÑÏÑù, Í≤ÄÏÉâ, ÌÜµÍ≥ÑÏóê Í∞ïÎ†•Ìï©ÎãàÎã§."
    }
    ```
    

### Match - Îã®Ïñ¥Î•º Î∂ÑÏÑùÌï¥ÏÑú Í≤ÄÏÉâ

```java
GET http://localhost:9200/posts/_search
{
  "query": {
    "match": {
      "title": "Í≤ÄÏÉâÏóîÏßÑ"
    }
  }
}
```

- ‚ÄúÍ≤ÄÏÉâÏóîÏßÑ‚ÄùÏùÄ ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°ú ‚ÄúÍ≤ÄÏÉâ‚Äù+‚ÄùÏóîÏßÑ‚Äù+‚ÄùÏûÖÎãàÎã§‚ÄùÏúºÎ°ú Î∂ÑÏÑùÎêòÏñ¥ Ï∞æÏïÑÏßÑÎã§
    - ÎùºÍ≥† ÏòàÏÉÅÏùÑ ÌñàÎäîÎç∞ Í≤ÄÏÉâÏù¥ Ïïà ÎêúÎã§
    - NoriÎ∂ÑÏÑùÍ∏∞ ÎòêÎäî IK Î∂ÑÏÑùÍ∏∞ Í∞ôÏùÄ ÌïúÍ∏Ä Ï†ÑÏö© Î∂ÑÏÑùÍ∏∞Î•º ÏÇ¨Ïö©Ìï¥Ïïº ÌïúÎã§.
    ÏïÑÎûòÏóê Í≥ÑÏÜç..

### Term - Îã®Ïñ¥ Ï†ÑÏ≤¥Í∞Ä Ï†ïÌôïÌûà ÏùºÏπòÌï† ÎïåÎßå Í≤ÄÏÉâ

```java
GET http://localhost:9200/posts/_search
{
  "query": {
    "term": {
      "title.keyword": "ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî ÎÜÄÎùºÏö¥ Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§."
    }
  }
}
```

- Í≤∞Í≥º
    - `title.keyword` ÌïÑÎìúÎäî Î∂ÑÏÑù ÏóÜÏù¥ Ï†ÑÏ≤¥ Î¨∏ÏûêÏó¥ Í∏∞Ï§Ä Í≤ÄÏÉâ
    - ‚ÄúÏ†ïÌôïÌûà Ïù¥ Îã®Ïñ¥ÏôÄ ÏùºÏπòÌïòÎäî Í≤ÉÎßå Ï∞æÏïÑÏ§ò‚Äù : "Í≤ÄÏÉâÌï† Îã®Ïñ¥ÎÇò Î¨∏Ïû•‚Äù

### Bool - Ïó¨Îü¨ Ï°∞Í±¥ÏùÑ ÎèôÏãúÏóê Ï§Ñ Îïå

```java
GET http://localhost:9200/posts/_search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "title": "Í≤ÄÏÉâ" } },
        { "match": { "content": "Elasticsearch" } }
      ],
      "must_not": [
        { "match": { "title": "ÎäêÎ¶º" } }
      ]
    }
  }
}
```

---

# ÌòïÌÉúÏÜå Î∂ÑÏÑù

> Nori Î∂ÑÏÑùÍ∏∞ Í∏∞Î∞ò elasticsearch Ïù∏Îç±Ïä§ ÏÑ§Í≥ÑÎ•º ÎßåÎì§Ïñ¥Î≥¥Ïûê
> 
- Nori Analyzer ÏÑ§ÏπòÎ•º Ìï¥Ï£ºÏûê

```java
// Nori Analyzer ÏÑ§Ïπò
docker exec -it [elasticsearch-container-name] bin/elasticsearch-plugin install analysis-nori
// Ïª®ÌÖåÏù¥ÎÑà Ïû¨Ïã§Ìñâ
docker restart [elasticsearch-container-name]

```

## 1. Í∏∞Ï°¥ Ïù∏Îç±Ïä§Í∞Ä ÏûàÎã§Î©¥ ÏÇ≠Ï†ú

```java
DELETE /posts
```

## 2. Nori Î∂ÑÏÑùÍ∏∞ Í∏∞Î∞ò Ïù∏Îç±Ïä§ ÎßåÎì§Í∏∞

- `title`Í≥º `content` ÌïúÍµ≠Ïñ¥ Í≤ÄÏÉâ ÏµúÏ†ÅÌôî

```java
PUT /posts_kor
{
  "settings": {
    "analysis": {
      "analyzer": {
        "my_korean_analyzer": {
          "type": "custom",
          "tokenizer": "nori_tokenizer"
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "my_korean_analyzer"
      },
      "content": {
        "type": "text",
        "analyzer": "my_korean_analyzer"
      }
    }
  }
}
```

## 3. Î¨∏ÏÑú Ï†ÄÏû•(POST)

```java
POST /posts_kor/_doc
{
  "title": "Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§",
  "content": "Ïö∞Î¶¨Îäî ÌïúÍµ≠Ïñ¥ ÌòïÌÉúÏÜå Î∂ÑÏÑùÍ∏∞Î°ú Í≤ÄÏÉâ ÌíàÏßàÏùÑ ÎÜíÏûÖÎãàÎã§"
}
```

## 4. Í≤ÄÏÉâ(GET with match)

```java
GET /posts_kor/_search
{
  "query": {
    "match": {
      "title": "Í≤ÄÏÉâÏóîÏßÑ"
    }
  }
}
```

## 5. Î∂ÑÏÑùÍ∏∞ ÏßÅÏ†ë ÌÖåÏä§Ìä∏

```java
GET /posts_kor/_analyze
{
  "analyzer": "my_korean_analyzer",
  "text": "Í≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§"
}
```

- Í≤∞Í≥º

```java
{
    "tokens": [
        {
            "token": "Í≤ÄÏÉâ",
            "start_offset": 0,
            "end_offset": 2,
            "type": "word",
            "position": 0
        },
        {
            "token": "ÏóîÏßÑ",
            "start_offset": 2,
            "end_offset": 4,
            "type": "word",
            "position": 1
        },
        {
            "token": "Ïù¥",
            "start_offset": 4,
            "end_offset": 7,
            "type": "word",
            "position": 2
        },
        {
            "token": "·ÑáÎãàÎã§",
            "start_offset": 4,
            "end_offset": 7,
            "type": "word",
            "position": 3
        }
    ]
}
```

- Nori Î∂ÑÏÑùÍ∏∞Í∞Ä `‚ÄúÍ≤ÄÏÉâÏóîÏßÑÏûÖÎãàÎã§‚Äù`Î•º ÏúÑÏôÄ Í∞ôÏù¥ Î∂ÑÎ¶¨Î•º ÌñàÍ∏∞ ÎïåÎ¨∏Ïóê `‚ÄúÍ≤ÄÏÉâÏóîÏßÑ‚Äù` Í≤ÄÏÉâÏóê ÏÑ±Í≥µÌñàÎã§

# ÏöîÏïΩ

- Í≤åÏãúÍ∏ÄÏùÑ Ï±ÖÏ≤òÎüº ElasticsearchÎùºÎäî ÎèÑÏÑúÍ¥ÄÏóê Ï†ÄÏû•ÌïúÎã§.
- KibanaÎùºÎäî ÏÑúÏÇ¨ÌïúÌÖå Î¨ºÏñ¥Î≥¥Î©¥ Í∏àÎ∞© Ï∞æÏïÑÏ§ÄÎã§.
- Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ï†ÄÏû•ÌïòÍ≥†, Îπ†Î•¥Í≤å Í≤ÄÏÉâÌïòÎäîÎç∞ ÏµúÍ≥†Îã§
